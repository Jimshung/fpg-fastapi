name: FPG è‡ªå‹•åŒ–æµç¨‹ (Python)
on:
  schedule:
    - cron: '0 0 * * 1-5'
  workflow_dispatch:

jobs:
  run-automation:
    runs-on: ubuntu-20.04
    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      LOGIN_URL: ${{ secrets.LOGIN_URL }}
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      AZURE_ENDPOINT: ${{ secrets.AZURE_ENDPOINT }}
      AZURE_API_KEY: ${{ secrets.AZURE_API_KEY }}
      CHROME_DRIVER_PATH: /usr/local/bin/chromedriver

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: å®‰è£ Chrome å’Œ ChromeDriver
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: å®‰è£ ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: å®‰è£ xvfb
        run: sudo apt-get install -y xvfb

      - name: å®‰è£ Python ä¾è³´
        run: pip install -r requirements.txt

      - name: å‰µå»ºæˆªåœ–ç›®éŒ„
        run: mkdir -p app/utils/screenshots

      - name: åŸ·è¡Œæœå°‹è…³æœ¬
        id: search_script
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          start_time=$(date +%s)
          # å°‡è¼¸å‡ºå°å‘åˆ°æª”æ¡ˆä¸¦åŒæ™‚ä¿å­˜åˆ°è®Šæ•¸
          log_output=$(xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" python app/scripts/run_automation.py 2>&1 | tee automation.log)
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=$duration" >> $GITHUB_OUTPUT

          # ç²å–å«æœ‰ app.services çš„ç¸½è¡Œæ•¸
          total_lines=$(echo "$log_output" | grep "app.services" | wc -l)
          mid_point=$((total_lines / 2))

          # æå–æ—¥èªŒä¸¦æ ¼å¼åŒ–æ™‚é–“
          log_summary=$(echo "$log_output" | grep "app.services" | awk '{
            # æå–æ™‚é–“ï¼Œåªä¿ç•™ HH:MM
            split($2, time, ":")
            hour_min = time[1] ":" time[2]
            # æå–è¨Šæ¯å…§å®¹
            sub(/.*INFO - /, "")
            # è¼¸å‡ºæ ¼å¼åŒ–å¾Œçš„è¡Œ
            print hour_min " â€¢ " $0
          }' | (
            # è¼¸å‡ºå‰10è¡Œ
            head -n 10
            echo "..."
            # è¼¸å‡ºä¸­é–“10è¡Œ
            tail -n +$((mid_point - 5)) | head -n 10
            echo "..."
            # è¼¸å‡ºæœ€å¾Œ10è¡Œ
            tail -n 10
          ))

          echo "log_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$log_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ç™¼é€ Telegram é€šçŸ¥
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            *FPG è‡ªå‹•åŒ–æµç¨‹åŸ·è¡Œå ±å‘Š* ğŸ¤–

            *åŸ·è¡Œç‹€æ…‹*: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
            *åŸ·è¡Œæ™‚é–“*: ${{ steps.search_script.outputs.duration }} ç§’
            *è§¸ç™¼æ–¹å¼*: ${{ github.event_name == 'schedule' && 'â° æ’ç¨‹' || 'ğŸ”„ æ‰‹å‹•' }}
            *åŸ·è¡Œåˆ†æ”¯*: ${{ github.ref_name }}

            *åŸ·è¡Œæ—¥èªŒæ‘˜è¦*:
            ```
            ã€é–‹å§‹ã€‘
            ${{ steps.search_script.outputs.log_summary }}
            ã€çµæŸã€‘
            ```

            ${{ job.status != 'success' && '*âŒ éŒ¯èª¤è©³æƒ…*: è«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„' || '' }}

            [ğŸ“‹ æŸ¥çœ‹è©³ç´°åŸ·è¡Œè¨˜éŒ„](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: ä¸Šå‚³çµæœ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: search-results
          path: |
            app/utils/screenshots/
            automation.log
            error.log
